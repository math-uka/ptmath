<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定格動畫生成器 6</title>
    <script src="https://cdn.jsdelivr.net/npm/libgif-js/dist/libgif.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        /* 保持之前的樣式不變 */
        /* ... [所有之前的CSS樣式保持不變] ... */
    </style>
</head>
<body>
    <!-- 保持之前的HTML結構不變 -->
    <!-- ... [所有之前的HTML結構保持不變] ... -->

    <script>
        // 全局變量
        let uploadedImages = [];
        let gif = null;
        
        // DOM元素 (保持不變)
        // ... [所有之前的DOM元素獲取代碼保持不變] ...

        // 上傳圖片處理 (保持不變)
        // ... [圖片上傳處理代碼保持不變] ...

        // 生成真正的GIF動畫
        generateBtn.addEventListener('click', async function() {
            if (uploadedImages.length === 0) return;
            
            const fps = parseInt(fpsInput.value) || 5;
            const delay = 100 / fps; // 轉換為厘秒
            
            gifOutputContainer.innerHTML = '<p>正在生成GIF動畫...</p>';
            gifOutput.style.display = 'none';
            downloadBtn.style.display = 'none';
            progressInfo.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressText.textContent = '初始化GIF生成器...';
            
            try {
                // 使用libgif.js創建GIF實例
                gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: uploadedImages[0].width,
                    height: uploadedImages[0].height,
                    workerScript: 'https://cdn.jsdelivr.net/npm/libgif-js/dist/gif.worker.js'
                });
                
                // 添加進度監聽
                gif.on('progress', function(p) {
                    const percent = Math.round(p * 100);
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                    progressText.textContent = `正在編碼 ${Math.round(p * uploadedImages.length)}/${uploadedImages.length} 幀`;
                });
                
                // 添加所有幀
                for (let i = 0; i < uploadedImages.length; i++) {
                    const img = uploadedImages[i];
                    gif.addFrame(img.canvas, {
                        delay: delay,
                        copy: true
                    });
                    
                    // 讓UI有時間更新
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                
                // 渲染GIF
                gif.on('finished', function(blob) {
                    const gifUrl = URL.createObjectURL(blob);
                    
                    // 顯示生成的GIF
                    gifOutput.src = gifUrl;
                    gifOutput.style.display = 'block';
                    gifOutputContainer.innerHTML = '';
                    gifOutputContainer.appendChild(gifOutput);
                    
                    // 設置下載按鈕
                    downloadBtn.style.display = 'inline-block';
                    downloadBtn.onclick = function() {
                        const a = document.createElement('a');
                        a.href = gifUrl;
                        a.download = 'animation.gif';
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(gifUrl);
                        }, 100);
                    };
                    
                    progressInfo.style.display = 'none';
                    statusMessage.textContent = `GIF生成成功！尺寸: ${(blob.size/1024).toFixed(1)}KB`;
                });
                
                gif.render();
                
            } catch (error) {
                console.error("GIF生成錯誤:", error);
                statusMessage.textContent = "生成GIF時出錯: " + error.message;
                statusMessage.classList.add('error-message');
                progressInfo.style.display = 'none';
            }
        });

        // 測試生成功能 (更新為生成真正的GIF)
        testBtn.addEventListener('click', function() {
            // 創建5張測試動畫幀
            uploadedImages = [];
            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF'];
            
            for (let i = 0; i < 5; i++) {
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // 繪製不同顏色的圓
                ctx.fillStyle = colors[i];
                ctx.beginPath();
                ctx.arc(100, 100, 80, 0, Math.PI * 2);
                ctx.fill();
                
                // 添加幀編號
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`幀 ${i+1}`, 100, 110);
                
                uploadedImages.push({
                    src: canvas.toDataURL(),
                    width: canvas.width,
                    height: canvas.height,
                    canvas: canvas
                });
            }
            
            updatePreview();
            generateBtn.click();
        });

        // 清除所有 (保持不變)
        // ... [清除功能代碼保持不變] ...
    </script>
</body>
</html>
