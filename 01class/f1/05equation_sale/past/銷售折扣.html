<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>利潤率四公式計算器（田字格版 + 折扣）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "Microsoft JhengHei", Arial, sans-serif; 
            background: #f0f8ff; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 15px;
        }
        header { 
            background: #2c3e50; 
            color: white; 
            text-align: center; 
            padding: 12px; 
            font-size: 22px; 
            font-weight: bold; 
            width: 100%; 
            max-width: 1100px;
            border-radius: 10px;
        }
        .note { 
            text-align: center; 
            padding: 10px; 
            background: #fff2f2; 
            color: #c0392b; 
            font-weight: bold; 
            font-size: 15px; 
            width: 100%; 
            max-width: 1100px;
            margin: 15px 0;
            border-radius: 8px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 1100px;
        }
        .formula-section {
            background: #90ee90;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .formula-section h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .formula {
            display: inline-flex;
            align-items: center;
            font-size: 23px;
            font-weight: bold;
            gap: 6px; /* 進一步縮小間距 */
            flex-wrap: nowrap; /* 強制不換行 */
            justify-content: center;
        }
        .input {
            width: 98px;   /* 縮小主要輸入框 */
            height: 46px;
            border: 3px solid #2c3e50;
            border-radius: 8px;
            font-size: 19px;
            font-weight: bold;
            text-align: center;
            background: white;
        }
        .input.small {
            width: 70px;   /* 折扣與利潤率框再縮小 */
        }
        .input:disabled {
            background: #eee;
            color: #777;
            opacity: 0.8;
        }
        .fraction-line {
            width: 98px;
            height: 5px;
            background: black;
            margin: 8px auto;
            border-radius: 2px;
        }
        .fraction-line-long {
            width: 250px;  /* 配合縮小 */
            height: 5px;
            background: black;
            margin: 8px auto;
            border-radius: 2px;
        }
        .btn-group {
            text-align: center;
            margin: 12px 0 5px 0;
        }
        button {
            padding: 9px 25px;
            font-size: 17px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .calc-btn {
            background: #e74c3c;
            color: white;
        }
        .calc-btn:hover { background: #c0392b; }
        .reset-btn {
            background: #3498db;
            color: white;
        }
        .reset-btn:hover { background: #2980b9; }
        .result {
            text-align: center;
            font-size: 19px;
            font-weight: bold;
            color: #27ae60;
            min-height: 55px;
            padding: 8px;
            line-height: 1.5;
        }
        input::-webkit-inner-spin-button, input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <header>利潤率・原售價・利潤 四公式計算器（田字格版 + 折扣）</header>
    <div class="note">每格獨立計算，任一格計算完成後，全部輸入框都會鎖定<br>按任一格的「重置」即可解鎖並清空全部<br>折扣欄位：輸入 8 表示 8 折（即 0.8），留空視為不打折</div>
    
    <div class="grid-container">
        <!-- 公式一 -->
        <div class="formula-section">
            <h3>公式一：利潤 = 原售價 × 折扣 - 進價</h3>
            <div class="formula">
                <input type="text" id="profit1" class="input" placeholder="利潤">
                <span>=</span>
                <input type="text" id="price1" class="input" placeholder="原售價">
                <span>×</span>
                <input type="text" id="disc1" class="input small" placeholder="折扣">
                <span>-</span>
                <input type="text" id="cost1" class="input" placeholder="進價">
            </div>
            <div class="btn-group">
                <button class="calc-btn" onclick="calc1()">計算</button>
                <button class="reset-btn" onclick="globalReset()">重置</button>
            </div>
            <div class="result" id="result1"></div>
        </div>
        
        <!-- 公式二 -->
        <div class="formula-section">
            <h3>公式二：原售價 × 折扣 = 進價 × (1 + 利潤率%)</h3>
            <div class="formula">
                <input type="text" id="price2" class="input" placeholder="原售價">
                <span>×</span>
                <input type="text" id="disc2" class="input small" placeholder="折扣">
                <span>=</span>
                <input type="text" id="cost2" class="input" placeholder="進價">
                <span>×</span>
                <span>(</span>
                <span>1 +</span>
                <input type="text" id="rate2" class="input small" placeholder="利潤率">
                <span>%</span>
                <span>)</span>
            </div>
            <div class="btn-group">
                <button class="calc-btn" onclick="calc2()">計算</button>
                <button class="reset-btn" onclick="globalReset()">重置</button>
            </div>
            <div class="result" id="result2"></div>
        </div>
        
        <!-- 公式三 -->
        <div class="formula-section">
            <h3>公式三：利潤率% = (利潤 / 進價) × 100%</h3>
            <div class="formula">
                <input type="text" id="rate3" class="input small" placeholder="利潤率">
                <span>%=</span>
                <div style="text-align:center;">
                    <input type="text" id="profit3" class="input" placeholder="利潤">
                    <div class="fraction-line"></div>
                    <input type="text" id="cost3" class="input" placeholder="進價">
                </div>
                <span>×100</span>
            </div>
            <div class="btn-group">
                <button class="calc-btn" onclick="calc3()">計算</button>
                <button class="reset-btn" onclick="globalReset()">重置</button>
            </div>
            <div class="result" id="result3"></div>
        </div>
        
        <!-- 公式四（重點調整） -->
        <div class="formula-section">
            <h3>公式四：利潤率% = ((原售價 × 折扣 - 進價) / 進價) × 100%</h3>
            <div class="formula">
                <input type="text" id="rate4" class="input small" placeholder="利潤率">
                <span>%=</span>
                <div style="text-align:center;">
                    <div style="display:flex; align-items:center; justify-content:center; gap:6px;">
                        <span>(</span>
                        <input type="text" id="price4" class="input" placeholder="原售價">
                        <span>×</span>
                        <input type="text" id="disc4" class="input small" placeholder="折扣">
                        <span>-</span>
                        <input type="text" id="cost4" class="input" placeholder="進價">
                        <span>)</span>
                    </div>
                    <div class="fraction-line-long"></div>
                    <input type="text" id="cost4_bottom" class="input" placeholder="進價">
                </div>
                <span>×100</span>
            </div>
            <div class="btn-group">
                <button class="calc-btn" onclick="calc4()">計算</button>
                <button class="reset-btn" onclick="globalReset()">重置</button>
            </div>
            <div class="result" id="result4"></div>
        </div>
    </div>

    <script>
        function fmt(n) { return Number.isInteger(n) ? n : n.toFixed(2); }
        function get(id) { 
            const v = document.getElementById(id).value.trim(); 
            return (v === "" || v.toLowerCase() === "x") ? null : parseFloat(v); 
        }
        function getDisc(id) {
            const d = get(id);
            return d === null ? 1 : d / 10;
        }

        function lockAllInputs() {
            document.querySelectorAll('.input').forEach(input => {
                input.disabled = true;
            });
        }

        function globalReset() {
            document.querySelectorAll('.input').forEach(input => {
                input.value = '';
                input.disabled = false;
            });
            document.querySelectorAll('.result').forEach(result => {
                result.innerHTML = '';
            });
        }

        // 公式一
        function calc1() {
            const p = get('profit1'), s = get('price1'), d = getDisc('disc1'), c = get('cost1');
            const realS = s === null ? null : s * d;
            const res = document.getElementById('result1');
            if (p === null && s === null && c === null) { res.innerHTML = '<span style="color:#e74c3c;">請至少輸入一個數值</span>'; return; }
            let out = "";
            if (p === null && realS !== null && c !== null) out += `利潤 = <span style="color:#e74c3c;">${fmt(realS - c)}</span> 元<br>`;
            if (realS === null && p !== null && c !== null) out += `原售價 = <span style="color:#e74c3c;">${fmt((p + c) / d)}</span> 元<br>`;
            if (c === null && p !== null && realS !== null) out += `進價 = <span style="color:#e74c3c;">${fmt(realS - p)}</span> 元<br>`;
            if (p !== null && realS !== null && c !== null) out = `驗證正確`;
            if (d < 1 && s !== null) out += `（${fmt(d*10)} 折實收 ${fmt(realS)} 元）`;
            res.innerHTML = out || "無法計算";
            lockAllInputs();
        }

        // 公式二
        function calc2() {
            const s = get('price2'), d = getDisc('disc2'), c = get('cost2'), r = get('rate2');
            const realS = s === null ? null : s * d;
            const res = document.getElementById('result2');
            if (s === null && c === null && r === null) { res.innerHTML = '<span style="color:#e74c3c;">請至少輸入一個數值</span>'; return; }
            let out = "";
            if (realS === null && c !== null && r !== null) out += `原售價 = <span style="color:#e74c3c;">${fmt(c * (1 + r / 100) / d)}</span> 元<br>`;
            if (c === null && realS !== null && r !== null) out += `進價 = <span style="color:#e74c3c;">${fmt(realS / (1 + r / 100))}</span> 元<br>`;
            if (r === null && realS !== null && c !== null) out += `利潤率 = <span style="color:#e74c3c;">${fmt((realS / c - 1) * 100)}</span> %<br>`;
            if (realS !== null && c !== null && r !== null) out = `驗證正確`;
            if (d < 1 && s !== null) out += `（${fmt(d*10)} 折實收 ${fmt(realS)} 元）`;
            res.innerHTML = out || "無法計算";
            lockAllInputs();
        }

        // 公式三
        function calc3() {
            const r = get('rate3'), p = get('profit3'), c = get('cost3');
            const res = document.getElementById('result3');
            if (r === null && p === null && c === null) { res.innerHTML = '<span style="color:#e74c3c;">請至少輸入一個數值</span>'; return; }
            let out = "";
            if (r === null && p !== null && c !== null) out += `利潤率 = <span style="color:#e74c3c;">${fmt((p / c) * 100)}</span> %<br>`;
            if (p === null && r !== null && c !== null) out += `利潤 = <span style="color:#e74c3c;">${fmt(c * r / 100)}</span> 元<br>`;
            if (c === null && r !== null && p !== null) out += `進價 = <span style="color:#e74c3c;">${fmt(p / (r / 100))}</span> 元<br>`;
            if (r !== null && p !== null && c !== null) out = `驗證正確`;
            res.innerHTML = out;
            lockAllInputs();
        }

        // 公式四
        function calc4() {
            const r = get('rate4'), s = get('price4'), d = getDisc('disc4'), cTop = get('cost4'), cBot = get('cost4_bottom');
            const realS = s === null ? null : s * d;
            const res = document.getElementById('result4');
            if (r === null && s === null && cTop === null && cBot === null) { res.innerHTML = '<span style="color:#e74c3c;">請至少輸入一個數值</span>'; return; }
            if (cTop !== null && cBot !== null && cTop !== cBot) { 
                res.innerHTML = '<span style="color:#e74c3c;">錯誤：分子與分母進價必須相同！</span>'; 
                return; 
            }
            const cost = cTop ?? cBot;
            let out = "";
            if (r === null && realS !== null && cost !== null) out += `利潤率 = <span style="color:#e74c3c;">${fmt(((realS - cost) / cost) * 100)}</span> %<br>`;
            if (realS === null && r !== null && cost !== null) out += `原售價 = <span style="color:#e74c3c;">${fmt(cost * (1 + r / 100) / d)}</span> 元<br>`;
            if (cost === null && r !== null && realS !== null) out += `進價 = <span style="color:#e74c3c;">${fmt(realS / (1 + r / 100))}</span> 元<br>`;
            if (r !== null && realS !== null && cost !== null) out = `驗證正確`;
            if (d < 1 && s !== null) out += `（${fmt(d*10)} 折實收 ${fmt(realS)} 元）`;
            res.innerHTML = out || "無法計算";
            lockAllInputs();
        }
    </script>
</body>
</html>