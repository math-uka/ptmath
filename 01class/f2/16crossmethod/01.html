<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>十字相乘工具</title>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
<style>
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:"Microsoft JhengHei",Arial,sans-serif; background:#f5f7fa; padding:20px; }
  h1 { text-align:center; color:#2c3e50; margin-bottom:25px; font-size:2.4em; }

  .main { display:flex; gap:40px; max-width:1560px; margin:0 auto; align-items:flex-start; }
  .left, .right {
    background:white; padding:35px; border-radius:22px;
    box-shadow:0 12px 40px rgba(0,0,0,0.12); flex:1;
  }
  .left { min-width:580px; }
  .right { min-width:520px; font-size:1.9em; line-height:1.8; }

  table { margin:30px auto; border-collapse:collapse; font-size:2.2em; }
  td {
    width:160px; height:110px; text-align:center; vertical-align:middle;
    border:5px solid #333; transition:all 0.5s ease;
  }
  .black { background:#000; }
  .input { background:#fffbe6; }
  input { width:95%; height:70%; font-size:1em; text-align:center; border:none; background:transparent; }
  .cell { background:#fff9c4; }
  .highlight-factor { background:#a5d8ff !important; box-shadow:0 0 25px #3399ff; }
  .highlight-result { background:#ffeb3b !important; box-shadow:0 0 35px #ff9800; transform:scale(1.08); }

  .highlight-add {
    background:#ff9800 !important;
    box-shadow:0 0 50px #ff5722 !important;
    color:white !important;
    transform:scale(1.18) !important;
    font-weight:bold;
  }

  .calc-btn {
    display:block; margin:35px auto 0; padding:18px 80px;
    font-size:1.7em; background:#e91e63; color:white; border:none;
    border-radius:50px; cursor:pointer; box-shadow:0 10px #ad1457;
  }
  .calc-btn:hover { background:#c2185b; }
  .calc-btn:disabled { background:#999; cursor:not-allowed; }

  .result-box {
    background:#f8fff8; padding:35px 40px; border-left:12px solid #4caf50;
    border-radius:14px; min-height:220px;
  }
  .add-display { text-align:center; margin:20px 0 15px; min-height:80px; }
  @media (max-width:1150px) { .main { flex-direction:column; } }
</style>
</head>
<body>
<h1>十字相乘工具</h1>

<div class="main">
  <div class="left">
    <table id="grid">
      <tr>
        <td class="black"></td>
        <td class="input"><input type="text" id="b" value="x"   placeholder="例 x+2"></td>
        <td class="input"><input type="text" id="c" value="+3"  placeholder="例 3"></td>
      </tr>
      <tr>
        <td class="input"><input type="text" id="d" value="x"   placeholder="例 x-1"></td>
        <td id="e" class="cell">?</td>
        <td id="f" class="cell">?</td>
      </tr>
      <tr>
        <td class="input"><input type="text" id="h" value="-5"  placeholder="例 +4"></td>
        <td id="k" class="cell">?</td>
        <td id="m" class="cell">?</td>
      </tr>
    </table>
    <button class="calc-btn" id="calcBtn">計算結果</button>
  </div>

  <div class="right">
    <div class="result-box" id="finalResult"></div>
  </div>
</div>

<script>
function parse(poly){
  if(!poly||poly.trim()==='')return[{coeff:1,power:1}];
  poly=poly.replace(/\s/g,'').replace(/-/g,'+-');
  if(poly[0]==='+')poly=poly.slice(1);
  let terms=poly.split(/(?=[+-])/).filter(t=>t), res=[];
  for(let t of terms){
    if(!t)continue;
    let coeff=1,power=0;
    if(t==='x')power=1;
    else if(t==='-x'){coeff=-1;power=1;}
    else if(/^[-+]?\d*x$/.test(t)){coeff=t==='x'?1:t==='-x'?-1:parseFloat(t.replace('x',''))||1;power=1;}
    else if(/^[-+]?\d*\.?\d*x\^\d+$/.test(t)){let[c,p]=t.split('x^');coeff=c===''||c==='+'?1:c==='-'?-1:parseFloat(c);power=parseInt(p);}
    else if(/^[-+]?\d*\.?\d*x?$/.test(t)){
      if(t.includes('x')){let c=t.replace('x','');coeff=c===''||c==='+'?1:c==='-'?-1:parseFloat(c);power=1;}
      else{coeff=parseFloat(t);}
    }
    res.push({coeff,power});
  }
  return res;
}
function multiply(p1,p2){let a=parse(p1),b=parse(p2),r=[];for(let x of a)for(let y of b)r.push({coeff:x.coeff*y.coeff,power:x.power+y.power});return r;}
function combine(t){let m={};for(let x of t)m[x.power]=(m[x.power]||0)+x.coeff;return Object.keys(m).map(p=>({power:+p,coeff:m[p]})).sort((a,b)=>b.power-a.power);}

function toLatexForceSign(terms){
  if(!terms.length)return '+0';
  terms=combine(terms);
  return terms.map(t=>{
    let sign=t.coeff>0?'+' : '-';
    let abs=Math.abs(t.coeff);
    if(t.power===0)return sign+(abs===1?'1':abs);
    if(t.power===1)return sign+(abs===1?'x':abs+'x');
    return sign+(abs===1?`x^{${t.power}}`:`${abs}x^{${t.power}}`);
  }).join('');
}

function toLatexNormal(terms){
  if(!terms.length)return '0';
  terms=combine(terms);
  let parts=[];
  terms.forEach((t,i)=>{
    if(t.coeff===0)return;
    let sign=i===0?(t.coeff<0?'-':''):(t.coeff>0?' + ':' - ');
    let abs=Math.abs(t.coeff);
    let txt=t.power===0?abs:t.power===1?(abs===1?'x':abs+'x'):(abs===1?`x^{${t.power}}`:`${abs}x^{${t.power}}`);
    parts.push(sign+txt);
  });
  return parts.join('')||'0';
}

// 只要輸入有變動 → e、m 更新 + f、k 變 ? + 右邊清空
function onInputChange(){
  let b=document.getElementById('b').value.trim();
  let c=document.getElementById('c').value.trim();
  let d=document.getElementById('d').value.trim();
  let h=document.getElementById('h').value.trim();

  // e、m 即時更新
  let eRes=multiply(b,d), mRes=multiply(c,h);
  document.getElementById('e').innerHTML='\\('+toLatexForceSign(eRes)+'\\)';
  document.getElementById('m').innerHTML='\\('+toLatexForceSign(mRes)+'\\)';

  // f、k 立刻變 ?
  document.getElementById('f').innerHTML='?';
  document.getElementById('k').innerHTML='?';

  // 右邊全部清空
  document.getElementById('finalResult').innerHTML = '';

  // 清除所有高亮
  ['e','f','k','m'].forEach(id=>{
    const el=document.getElementById(id);
    el.classList.remove('highlight-add','highlight-result');
    el.style.transform='';
  });
  document.querySelectorAll('td').forEach(td=>td.classList.remove('highlight-factor'));

  MathJax.typesetPromise();
}

async function typeAddWithHighlight(terms, cells, delay=900){
  const display=document.getElementById('addMath');
  let current='';
  for(let i=0;i<terms.length;i++){
    let term=terms[i];
    if(i===0 && term[0]==='+') term=term.slice(1);
    else if(i>0 && term[0]==='+') term='\\ '+term;
    else if(term[0]==='-') term='\\ '+term;
    current+=term;
    display.innerHTML=`\\(${current}\\)`;
    await MathJax.typesetPromise([display]);
    document.getElementById(cells[i]).classList.add('highlight-add');
    await new Promise(r=>setTimeout(r,delay));
  }
}

async function calculateWithAnimation(){
  const btn=document.getElementById('calcBtn'); btn.disabled=true;

  let b=document.getElementById('b').value.trim();
  let c=document.getElementById('c').value.trim();
  let d=document.getElementById('d').value.trim();
  let h=document.getElementById('h').value.trim();

  let eRes=multiply(b,d), fRes=multiply(c,d);
  let kRes=multiply(b,h), mRes=multiply(c,h);

  // 顯示 f
  await new Promise(r=>setTimeout(r,500));
  document.getElementById('c').parentElement.classList.add('highlight-factor');
  document.getElementById('d').parentElement.classList.add('highlight-factor');
  await new Promise(r=>setTimeout(r,700));
  document.getElementById('f').classList.add('highlight-result');
  await new Promise(r=>setTimeout(r,500));
  document.getElementById('f').innerHTML='\\('+toLatexForceSign(fRes)+'\\)';
  MathJax.typesetPromise();
  await new Promise(r=>setTimeout(r,800));

  // 顯示 k
  document.querySelectorAll('td').forEach(td=>td.classList.remove('highlight-factor','highlight-result'));
  await new Promise(r=>setTimeout(r,300));
  document.getElementById('b').parentElement.classList.add('highlight-factor');
  document.getElementById('h').parentElement.classList.add('highlight-factor');
  await new Promise(r=>setTimeout(r,700));
  document.getElementById('k').classList.add('highlight-result');
  await new Promise(r=>setTimeout(r,500));
  document.getElementById('k').innerHTML='\\('+toLatexForceSign(kRes)+'\\)';
  MathJax.typesetPromise();
  await new Promise(r=>setTimeout(r,600));

  // 四格相加
  document.querySelectorAll('td').forEach(td=>td.classList.remove('highlight-factor','highlight-result'));
  document.getElementById('finalResult').innerHTML=`
    <strong>四格相加：</strong><br>
    <div class="add-display"><span id="addMath"></span></div>
  `;

  await typeAddWithHighlight(
    [toLatexForceSign(eRes),toLatexForceSign(fRes),toLatexForceSign(kRes),toLatexForceSign(mRes)],
    ['e','f','k','m'],
    900
  );

  // 合併結果 + 熄燈
  await new Promise(r=>setTimeout(r,600));
  let final=toLatexNormal(combine([...eRes,...fRes,...kRes,...mRes]));
  document.getElementById('finalResult').innerHTML+=`<br><strong>合併同類項後：</strong><br>\\(${final}\\)`; 
  MathJax.typesetPromise();

  ['e','f','k','m'].forEach(id=>{
    const el=document.getElementById(id);
    el.classList.remove('highlight-add');
    el.style.transform='';
  });

  btn.disabled=false;
}

function setupAutoPlus(id){
  document.getElementById(id).addEventListener('blur',function(){
    let v=this.value.trim();
    if(v && !/^[-+]/.test(v) && /^((\d*\.?\d*)x(\^\d+)?|x|\d*\.?\d+)$/.test(v)){
      this.value='+'+v;
    }
    onInputChange();
  });
}

window.onload=()=>{
  ['b','c','d','h'].forEach(setupAutoPlus);
  document.querySelectorAll('input').forEach(i=>i.addEventListener('input',onInputChange));
  document.getElementById('calcBtn').addEventListener('click',calculateWithAnimation);
  onInputChange(); // 初始載入
};
</script>
</body>
</html>