<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>因式分解計算工具</title>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
<style>
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:"Microsoft JhengHei",Arial,sans-serif; background:#f5f7fa; padding:20px; }
  h1 { text-align:center; color:#2c3e50; margin-bottom:25px; font-size:2.4em; }
  .main { display:flex; gap:40px; max-width:1400px; margin:0 auto; align-items:flex-start; }
  .left, .right { background:white; padding:35px; border-radius:22px; box-shadow:0 12px 40px rgba(0,0,0,0.12); flex:1; }
  .left { min-width:680px; }
  .right { min-width:520px; font-size:1.9em; line-height:1.8; }
  table { margin:30px auto; border-collapse:collapse; font-size:2.2em; }
  td { width:160px; height:110px; text-align:center; vertical-align:middle; border:5px solid #333; transition:all 0.5s ease; }
  .black { background:#000; }
  .input { background:#fffbe6; }
  input { width:95%; height:70%; font-size:1em; text-align:center; border:none; background:transparent; }
  input::placeholder { color:#999; opacity:1; }
  .cell { background:#fff9c4; }
  .highlight-add { background:#ff9800 !important; box-shadow:0 0 50px #ff5722 !important; color:white !important; transform:scale(1.18) !important; font-weight:bold; }
  .calc-btn { display:block; margin:35px auto 0; padding:18px 80px; font-size:1.7em; background:#e91e63; color:white; border:none; border-radius:50px; cursor:pointer; box-shadow:0 10px #ad1457; }
  .calc-btn:hover { background:#c2185b; }
  .calc-btn:disabled { background:#999; cursor:not-allowed; }
  .result-box { background:#f8fff8; padding:35px 40px; border-left:12px solid #4caf50; border-radius:14px; min-height:220px; }
  .add-display { text-align:center; margin:20px 0 15px; min-height:80px; }
  p.note { text-align:center; margin-bottom:30px; font-size:1.3em; color:#444; }
  @media (max-width:1150px) { .main { flex-direction:column; } }
</style>
</head>
<body>
<h1>因式分解計算工具（3×2 版）</h1>

<div class="main">
  <div class="left">
    <table id="grid">
      <tr>
        <td class="black"></td>
        <td class="input"><input type="text" id="top1" value="x^2" placeholder="例：x^2"></td>
        <td class="input"><input type="text" id="top2" placeholder="例：-ax 或 -2x"></td>
        <td class="input"><input type="text" id="top3" placeholder="例：+a² 或 +4"></td>
      </tr>
      <tr>
        <td class="input"><input type="text" id="side1" placeholder="例：x"></td>
        <td class="cell" id="r11">?</td>
        <td class="cell" id="r12">?</td>
        <td class="cell" id="r13">?</td>
      </tr>
      <tr>
        <td class="input"><input type="text" id="side2" placeholder="例：+a 或 +2"></td>
        <td class="cell" id="r21">?</td>
        <td class="cell" id="r22">?</td>
        <td class="cell" id="r23">?</td>
      </tr>
    </table>
    <button class="calc-btn" id="calcBtn">計算結果</button>
  </div>
  <div class="right">
    <div class="result-box" id="finalResult"></div>
  </div>
</div>

<script>
// ---------- 多項式解析與運算 ----------
function parse(poly){
  if(!poly||poly.trim()==='')return [];
  poly = poly.replace(/\s/g,'').replace(/-/g,'+-');
  if(poly[0]==='+')poly = poly.slice(1);
  let terms = poly.split(/(?=[+-])/).filter(t=>t);
  let res = [];
  for(let t of terms){
    if(!t) continue;
    let coeff = 1, power = 0;
    if(t === 'x') { power = 1; }
    else if(t === '-x') { coeff = -1; power = 1; }
    else if(t.match(/^[-+]?\d*\.?\d*x$/)) {
      coeff = t === 'x' ? 1 : t === '-x' ? -1 : parseFloat(t.replace('x','')) || 1;
      power = 1;
    }
    else if(t.match(/^[-+]?\d*\.?\d*x\^\d+$/)){
      let parts = t.split('x^');
      let c = parts[0];
      coeff = c==='' || c==='+' ? 1 : c==='-' ? -1 : parseFloat(c);
      power = parseInt(parts[1]);
    }
    else if(t.match(/^[-+]?\d*\.?\d*x?$/)){
      if(t.includes('x')){
        let c = t.replace(/x.*$/,'');
        coeff = c==='' || c==='+' ? 1 : c==='-' ? -1 : parseFloat(c) || 1;
        power = 1;
      } else {
        coeff = parseFloat(t);
        power = 0;
      }
    }
    if(!isNaN(coeff) && !isNaN(power)) res.push({coeff, power});
  }
  return res;
}

function multiply(p1, p2){
  let a = parse(p1), b = parse(p2);
  if(a.length === 0 || b.length === 0) return [];
  let r = [];
  for(let x of a) for(let y of b) r.push({coeff: x.coeff * y.coeff, power: x.power + y.power});
  return r;
}

function combine(t){
  let m = {};
  for(let x of t) m[x.power] = (m[x.power] || 0) + x.coeff;
  return Object.keys(m).sort((a,b)=> +b - +a).map(p => ({power: +p, coeff: m[p]}));
}

function toLatexForceSign(terms){
  if(terms.length === 0) return '+0';
  terms = combine(terms);
  return terms.map(t => {
    let sign = t.coeff > 0 ? '+' : '-';
    let abs = Math.abs(t.coeff);
    if(t.power === 0) return sign + (abs === 1 ? '1' : abs);
    if(t.power === 1) return sign + (abs === 1 ? 'x' : abs + 'x');
    return sign + (abs === 1 ? `x^{${t.power}}` : `${abs}x^{${t.power}}`);
  }).join('');
}

function toLatexNormal(terms){
  if(terms.length === 0) return '0';
  terms = combine(terms);
  let parts = [];
  terms.forEach((t, i) => {
    if(t.coeff === 0) return;
    let sign = i === 0 ? (t.coeff < 0 ? '-' : '') : (t.coeff > 0 ? ' + ' : ' - ');
    let abs = Math.abs(t.coeff);
    let txt = t.power === 0 ? abs : t.power === 1 ? (abs === 1 ? 'x' : abs + 'x') : (abs === 1 ? `x^{${t.power}}` : `${abs}x^{${t.power}}`);
    parts.push(sign + txt);
  });
  return parts.join('') || '0';
}

function nice(raw){
  let s = raw.trim();
  if(!s) return '';
  if(/^[-+]/.test(s)) return s;
  return '+' + s;
}

function displayResult(id, terms){
  if(terms.length === 0){
    document.getElementById(id).innerHTML = '?';
  } else {
    document.getElementById(id).innerHTML = '\\(' + toLatexForceSign(terms) + '\\)';
  }
}

// ---------- 即時更新 ----------
function onInputChange(){
  const tops = ['top1','top2','top3'];
  const sides = ['side1','side2'];
  const cellMap = [['r11','r12','r13'],['r21','r22','r23']];

  let cellIds = [];

  for(let i = 0; i < sides.length; i++){
    let sideVal = document.getElementById(sides[i]).value.trim();
    for(let j = 0; j < tops.length; j++){
      let topVal = document.getElementById(tops[j]).value.trim();
      let res = multiply(topVal, sideVal);
      let cellId = cellMap[i][j];
      displayResult(cellId, res);
      cellIds.push(cellId);
    }
  }

  document.getElementById('finalResult').innerHTML = '';

  cellIds.forEach(id => {
    let el = document.getElementById(id);
    if(el){
      el.classList.remove('highlight-add');
      el.style.transform = '';
    }
  });

  MathJax.typesetPromise();
}

async function typeAddWithHighlight(terms, cells, delay = 900){
  const display = document.getElementById('addMath');
  let current = '';
  for(let i = 0; i < terms.length; i++){
    let term = terms[i];
    if(i === 0 && term[0] === '+') term = term.slice(1);
    else if(i > 0 && term[0] === '+') term = '\\ ' + term;
    else if(term[0] === '-') term = '\\ ' + term;
    current += term;
    display.innerHTML = `\\(${current}\\)`;
    await MathJax.typesetPromise([display]);
    document.getElementById(cells[i]).classList.add('highlight-add');
    await new Promise(r => setTimeout(r, delay));
  }
}

async function calculateWithAnimation(){
  const btn = document.getElementById('calcBtn');
  btn.disabled = true;

  const tops = ['top1','top2','top3'];
  const sides = ['side1','side2'];
  const cellMap = [['r11','r12','r13'],['r21','r22','r23']];

  let cellIds = [];
  let allTermsList = [];

  for(let i = 0; i < sides.length; i++){
    let sideVal = document.getElementById(sides[i]).value.trim();
    for(let j = 0; j < tops.length; j++){
      let topVal = document.getElementById(tops[j]).value.trim();
      let res = multiply(topVal, sideVal);
      let cellId = cellMap[i][j];
      cellIds.push(cellId);
      allTermsList.push(res);
    }
  }

  let termsForAdd = allTermsList.map(toLatexForceSign);

  document.getElementById('finalResult').innerHTML = `
    <strong>六格逐項相加：</strong><br>
    <div class="add-display"><span id="addMath"></span></div>
  `;

  await typeAddWithHighlight(termsForAdd, cellIds, 900);

  let allTerms = [].concat(...allTermsList);
  let combined = combine(allTerms);
  let finalStr = toLatexNormal(combined);

  // 先左側 (side)，再上方 (top)
  let factorSide = sides.map(id => nice(document.getElementById(id).value.trim())).join('');
  let factorTop = tops.map(id => nice(document.getElementById(id).value.trim())).join('');
  if(factorSide.startsWith('+')) factorSide = factorSide.substring(1);
  if(factorTop.startsWith('+')) factorTop = factorTop.substring(1);
  if(!factorSide) factorSide = '0';
  if(!factorTop) factorTop = '0';

  document.getElementById('finalResult').innerHTML += `
    <br><strong>原式＝</strong><br>
    \\(${finalStr}\\) 
    <br><br>
    = \\( (${factorSide})(${factorTop}) \\)
  `;

  await MathJax.typesetPromise();

  cellIds.forEach(id => {
    let el = document.getElementById(id);
    if(el){
      el.classList.remove('highlight-add');
      el.style.transform = '';
    }
  });

  btn.disabled = false;
}

function setupAutoPlus(id){
  document.getElementById(id).addEventListener('blur', function(){
    let v = this.value.trim();
    if(v && !/^[-+]/.test(v) && /^((\d*\.?\d*)x(\^\d+)?|x|\d*\.?\d+)$/.test(v)){
      this.value = '+' + v;
    }
    onInputChange();
  });
}

window.onload = () => {
  const inputs = ['top1','top2','top3','side1','side2'];
  inputs.forEach(setupAutoPlus);
  document.querySelectorAll('input').forEach(i => i.addEventListener('input', onInputChange));
  document.getElementById('calcBtn').addEventListener('click', calculateWithAnimation);
  onInputChange();
};
</script>
</body>
</html>