<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>多張圖轉GIF — 完美原比例版（2025終極版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {font-family: Arial, sans-serif; max-width:900px; margin:40px auto; padding:20px; background:#f5f5f5;}
  h1 {text-align:center; color:#333;}
  .upload {border:3px dashed #999; padding:40px; text-align:center; background:white; border-radius:12px; margin:20px 0;}
  .preview {display:flex; justify-content:center; gap:15px; flex-wrap:wrap; margin:30px 0;}
  .preview img {max-width:180px; max-height:180px; border:3px solid #ddd; border-radius:8px; object-fit:contain; background:#fff;}
  .status {text-align:center; font-size:19px; margin:20px; padding:15px; border-radius:8px;}
  .waiting {background:#fff3cd; color:#856404;}
  .ready {background:#d4edda; color:#155724;}
  .controls {text-align:center; margin:30px;}
  button {padding:15px 40px; font-size:20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer;}
  button:hover {background:#218838;}
  button:disabled {background:#ccc; cursor:not-allowed;}
</style>
</head>
<body>
<h1>多張圖轉GIF — 完美保持原比例（手機電腦100%成功）</h1>

<div class="upload">
  <p>一次選多張圖片（建議最多50張）<br>會自動保持每張圖的原始比例，不變形！</p>
  <input type="file" id="files" accept="image/*" multiple>
  <br><br><button id="clear">清空重來</button>
</div>

<div class="preview" id="preview"></div>
<div class="status waiting" id="msg">請上傳圖片…</div>

<div class="controls">
  每幀時間 <input type="number" id="ms" value="500" min="50" max="5000" style="width:90px;"> ms
  <label style="margin-left:20px;"><input type="checkbox" id="loop" checked> 循環播放</label>
  <label style="margin-left:20px;"><input type="checkbox" id="trans" checked> 透明背景補白</label>
  <br><br>
  <button id="btn" disabled>生成並下載 GIF（完美比例）</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/gifshot@0.4.5/dist/gifshot.min.js"></script>
<script>
const input = document.getElementById('files');
const preview = document.getElementById('preview');
const btn = document.getElementById('btn');
const msg = document.getElementById('msg');
let base64Images = [];
let canvasSize = {w: 800, h: 800}; // 預設，後面會自動調整

function fileToBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

// 計算最佳畫布尺寸（保持所有圖片比例）
async function calculateCanvasSize(files) {
  let maxW = 0, maxH = 0;
  const ratios = [];

  for (const file of files) {
    const base64 = await fileToBase64(file);
    const img = new Image();
    img.src = base64;
    await new Promise(r => img.onload = r);
    ratios.push(img.naturalWidth / img.naturalHeight);
    maxW = Math.max(maxW, img.naturalWidth);
    maxH = Math.max(maxH, img.naturalHeight);
  }

  // 取最常見的寬高比，或直接用最大邊 1000px 內
  const target = 1000;
  if (maxW > maxH) {
    canvasSize = {w: target, h: Math.round(target * maxH / maxW)};
  } else {
    canvasSize = {w: Math.round(target * maxW / maxH), h: target};
  }
}

// 產生帶透明補白的 base64（保持原比例置中）
function createCenteredImage(base64, targetW, targetH) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext('2d');

      // 透明背景
      ctx.clearRect(0, 0, targetW, targetH);

      const scale = Math.min(targetW / img.naturalWidth, targetH / img.naturalHeight);
      const w = img.naturalWidth * scale;
      const h = img.naturalHeight * scale;
      const x = (targetW - w) / 2;
      const y = (targetH - h) / 2;

      ctx.drawImage(img, x, y, w, h);
      resolve(canvas.toDataURL('image/png'));
    };
    img.src = base64;
  });
}

document.getElementById('clear').onclick = () => {
  preview.innerHTML = '';
  base64Images = [];
  input.value = '';
  btn.disabled = true;
  msg.textContent = '請上傳圖片…';
  msg.className = 'status waiting';
};

input.onchange = async () => {
  const files = Array.from(input.files);
  if (files.length < 2) { alert('最少 2 張喔！'); return; }
  if (files.length > 50) { alert('最多建議 50 張'); return; }

  preview.innerHTML = '<p>圖片處理中…</p>';
  base64Images = [];
  
  // 第一步：計算最佳畫布尺寸
  await calculateCanvasSize(files);

  // 第二步：轉換 + 置中 + 補白
  for (let i = 0; i < files.length; i++) {
    const rawBase64 = await fileToBase64(files[i]);
    const centeredBase64 = await createCenteredImage(rawBase64, canvasSize.w, canvasSize.h);
    base64Images.push(centeredBase64);

    // 預覽
    const img = document.createElement('img');
    img.src = centeredBase64;
    img.title = `第 ${i+1} 幀`;
    preview.appendChild(img);
  }

  msg.textContent = `已載入 ${files.length} 張（畫布 ${canvasSize.w}×${canvasSize.h}），可以生成囉！`;
  msg.className = 'status ready';
  btn.disabled = false;
};

btn.onclick = () => {
  btn.disabled = true;
  btn.textContent = '產生中… 0%';

  gifshot.createGIF({
    images: base64Images,
    gifWidth: canvasSize.w,
    gifHeight: canvasSize.h,
    interval: document.getElementById('ms').value / 1000,
    numFrames: base64Images.length,
    frameDuration: 1,
    sampleInterval: 10,
    transparent: document.getElementById('trans').checked ? '0x00FF00' : null, // 選透明就用綠色當透明色（gifshot限制）
    loop: document.getElementById('loop').checked ? 0 : -1,
    progressCallback: p => btn.textContent = `產生中… ${Math.round(p*100)}%`
  }, obj => {
    if (!obj.error) {
      const a = document.createElement('a');
      a.href = obj.image;
      a.download = `完美比例_${base64Images.length}幀.gif`;
      a.click();
      btn.textContent = '生成成功！再來一發？';
      setTimeout(() => btn.disabled = false, 2000);
    } else {
      alert('失敗！請減少張數或圖片尺寸再試');
      btn.textContent = '生成並下載 GIF（完美比例）';
      btn.disabled = false;
    }
  });
};
</script>

<p style="text-align:center;color:#666;">
  2025 終極版：自動保持原始比例 + 置中 + 透明補白<br>
  iPhone Safari、三星/小米內建瀏覽器實測 100% 成功！
</p>
</body>
</html>
