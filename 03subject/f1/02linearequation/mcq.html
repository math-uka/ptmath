<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一元一次方程練習</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        h1 {
            font-size: 20px;
            margin: 10px 0;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 600px;
            align-items: center;
        }
        .math-problem {
            margin: 20px 0;
            font-size: 18px;
            text-align: center;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin: 10px 0;
        }
        .option-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            width: 100%;
        }
        .answerBtn {
            padding: 10px 15px;
            margin: 8px;
            font-size: 16px;
            min-width: 48px;
            min-height: 48px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 6px;
            text-align: center;
            touch-action: manipulation;
        }
        .answerBtn:active {
            background-color: #d0d0d0;
        }
        .answerBtn:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
        }
        .action-buttons button {
            padding: 10px 20px;
            margin: 8px;
            font-size: 16px;
            min-width: 80px;
            min-height: 48px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            color: #fff;
            touch-action: manipulation;
        }
        #hintBtn {
            background-color: #4CAF50;
        }
        #hintBtn:active {
            background-color: #388E3C;
        }
        #hintBtn:disabled {
            background-color: #81C784;
            cursor: not-allowed;
        }
        #nextProblemBtn {
            background-color: #2196F3;
        }
        #nextProblemBtn:active {
            background-color: #1976D2;
        }
        #nextProblemBtn:disabled {
            background-color: #64B5F6;
            cursor: not-allowed;
        }
        #passwordInput {
            padding: 10px;
            font-size: 16px;
            width: 120px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin: 8px;
        }
        #passwordInput:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }
        #confirmPasswordBtn {
            background-color: #2196F3;
            border: none;
            color: #fff;
        }
        #confirmPasswordBtn:active {
            background-color: #1976D2;
        }
        #confirmPasswordBtn:disabled {
            background-color: #64B5F6;
            cursor: not-allowed;
        }
        #answer, #hint {
            display: none;
            margin: 20px 0;
            color: #4CAF50;
            font-size: 16px;
            text-align: center;
        }
        #stars {
            margin: 10px 0;
            font-size: 28px;
            color: #FFD700;
            text-align: center;
        }
        #feedback {
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            width: 100%;
        }
        #feedback.correct {
            color: #4CAF50;
        }
        #feedback.incorrect {
            color: #FF0000;
        }
        #congratulations {
            display: none;
            margin: 20px 0;
            font-size: 20px;
            color: #4CAF50;
            font-weight: bold;
            text-align: center;
            width: 100%;
        }
        #passwordContainer {
            display: none;
            margin: 20px 0;
            text-align: center;
            width: 100%;
        }
        #passwordResult {
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            width: 100%;
        }
        #passwordResult.error {
            color: #FF0000;
        }
        #passwordResult.success {
            color: #4CAF50;
        }
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        @keyframes shake {
            0% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 0); }
            20%, 40%, 60%, 80% { transform: translate(5px, 0); }
            100% { transform: translate(0, 0); }
        }
        #content.shake {
            animation: shake 0.5s;
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 18px;
            }
            .math-problem {
                font-size: 16px;
            }
            .answerBtn {
                padding: 8px 12px;
                font-size: 14px;
                min-width: 48px;
                min-height: 48px;
                margin: 6px;
            }
            .action-buttons button {
                padding: 8px 16px;
                font-size: 14px;
                min-width: 70px;
                min-height: 48px;
                margin: 6px;
            }
            #passwordInput {
                width: 100px;
                font-size: 14px;
            }
            #answer, #hint {
                font-size: 14px;
            }
            #stars {
                font-size: 24px;
            }
            #feedback {
                font-size: 16px;
            }
            #congratulations, #passwordContainer {
                font-size: 18px;
            }
            #passwordResult {
                font-size: 16px;
            }
            footer {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>
    <div id="content">
        <h1>一元一次方程練習</h1>
        <div id="stars"></div>
        <div id="feedback"></div>
        <div class="container">
            <div class="math-problem" id="problem"></div>
            <div class="controls" id="controls"></div>
            <div id="hint"></div>
            <div id="answer"></div>
            <div id="congratulations"></div>
            <div id="passwordContainer">
                <div class="input-group">
                    <label for="passwordInput">輸入 1~50 的數字以獲取密碼：</label>
                    <input type="text" id="passwordInput" placeholder="輸入數字">
                    <button id="confirmPasswordBtn" onclick="submitPasswordInput()">確定</button>
                </div>
                <div id="passwordResult"></div>
            </div>
        </div>
        <footer>
            <p>© 2025 ukawai</p>
        </footer>
    </div>
<script>
    let problemCount = 0;
    let hintLevel = 0;
    let currentProblem = null;
    let hints = [];
    let starCount = 0;
    let hasPassJson = false;
    let passJson = null;

    async function checkPassJson() {
        try {
            const response = await fetch('pass.json');
            if (response.ok) {
                passJson = await response.json();
                hasPassJson = true;
                console.log('pass.json loaded successfully');
            } else {
                hasPassJson = false;
                console.log('pass.json not found, continuing without password input');
            }
        } catch (e) {
            hasPassJson = false;
            console.warn('Failed to load pass.json:', e);
        }
    }

    function gcd(a, b) {
        a = Math.abs(a);
        b = Math.abs(b);
        while (b) {
            const t = b;
            b = a % b;
            a = t;
        }
        return a;
    }

    function toFraction(value, maxDenominator = 1000) {
        try {
            if (Number.isInteger(value)) {
                return { num: value, denom: 1 };
            }
            let bestNum = 1;
            let bestDenom = 1;
            let bestError = Math.abs(value - bestNum / bestDenom);
            for (let denom = 1; denom <= maxDenominator; denom++) {
                const num = Math.round(value * denom);
                const error = Math.abs(value - num / denom);
                if (error < bestError) {
                    bestNum = num;
                    bestDenom = denom;
                    bestError = error;
                }
            }
            const divisor = gcd(bestNum, bestDenom);
            return { num: bestNum / divisor, denom: bestDenom / divisor };
        } catch (e) {
            console.error('Error in toFraction:', e);
            return { num: 0, denom: 1 };
        }
    }

    function simplifyFraction(num, denom) {
        try {
            if (num === 0) return { num: 0, denom: 1 };
            const divisor = gcd(num, denom);
            return { num: num / divisor, denom: denom / divisor };
        } catch (e) {
            console.error('Error in simplifyFraction:', e);
            return { num: num, denom: denom };
        }
    }

    function parseInput(input) {
        try {
            if (!input) return null;
            if (input === '0') return { num: 0, denom: 1 };
            if (input.includes('/')) {
                const parts = input.split('/');
                if (parts.length !== 2) return null;
                let num = parseInt(parts[0].trim());
                let denom = parseInt(parts[1].trim());
                if (isNaN(num) || isNaN(denom) || denom === 0) return null;
                return simplifyFraction(num, denom);
            }
            const value = parseFloat(input);
            if (isNaN(value)) return null;
            return toFraction(value);
        } catch (e) {
            console.error('Error in parseInput:', e);
            return null;
        }
    }

    function areFractionsEqual(frac1, frac2) {
        try {
            if (!frac1 || !frac2) return false;
            return frac1.num * frac2.denom === frac2.num * frac1.denom;
        } catch (e) {
            console.error('Error in areFractionsEqual:', e);
            return false;
        }
    }

    function formatNumber(value) {
        try {
            if (typeof value === 'object') {
                if (value.num === 0) return '0';
                if (value.denom === 1) return value.num.toString();
                const sign = value.num < 0 ? '-' : '';
                return `${sign}\\frac{${Math.abs(value.num)}}{${value.denom}}`;
            }
            return value.toString();
        } catch (e) {
            console.error('Error in formatNumber:', e);
            return '0';
        }
    }

    function generateAnswerOptions(x, type, params) {
        try {
            const correct = toFraction(x);
            const zero = { num: 0, denom: 1 };
            const options = [];

            // Helper function to add a pair (option and its opposite)
            function addPair(opt) {
                const simplified = simplifyFraction(opt.num, opt.denom);
                const opposite = simplifyFraction(-opt.num, opt.denom);
                if (!options.some(o => areFractionsEqual(o, simplified))) {
                    options.push(simplified);
                }
                if (!options.some(o => areFractionsEqual(o, opposite))) {
                    options.push(opposite);
                }
            }

            // Add zero
            options.push(zero);

            // Specific handling for example equations
            if (type === 'c=dx' && params.c === 6 && params.d === 10) {
                // For 6 = 10x (x = 3/5)
                addPair(correct); // 3/5, -3/5
                addPair(simplifyFraction(5, 3)); // 5/3, -5/3
                addPair(simplifyFraction(4, 1)); // 4, -4
                addPair(simplifyFraction(16, 1)); // 16, -16
            } else if (type === 'c=dx' && params.c === 7 && params.d === 8) {
                // For 7 = 8x (x = 7/8)
                addPair(correct); // 7/8, -7/8
                addPair(simplifyFraction(56, 1)); // 56, -56
                addPair(simplifyFraction(8, 7)); // 8/7, -8/7
                addPair(simplifyFraction(1, 1)); // 1, -1
            } else if (type === 'ex+f=g' && params.e === 8 && params.f === 1 && params.g === -31) {
                // For 8x + 1 = -31 (x = -4)
                addPair(correct); // -4, 4
                addPair(simplifyFraction(15, 4)); // 15/4, -15/4
                addPair(simplifyFraction(240, 1)); // 240, -240
                addPair(simplifyFraction(256, 1)); // 256, -256
            } else {
                // General case for ax=b
                if (type === 'ax=b') {
                    addPair(correct); // x, -x
                    addPair(simplifyFraction(params.a + params.b, 1)); // a+b, -(a+b)
                    addPair(simplifyFraction(params.b - params.a, 1)); // b-a, -(b-a)
                    addPair(simplifyFraction(params.a - params.b, 1)); // a-b, -(a-b)
                    addPair(simplifyFraction(params.a, params.b)); // a/b, -(a/b)
                    addPair(simplifyFraction(params.b, params.a)); // b/a, -(b/a)
                } 
                // General case for ex+f=g, h=i+kx, m=l+nx
                else {
                    let noSignChange, swapFrac, mulDivError, addError1, addError2, divError1, divError2, addError3;
                    switch (type) {
                        case 'ex+f=g':
                            noSignChange = toFraction((params.f - params.g) / params.e);
                            swapFrac = correct.denom !== 1 && correct.num !== 0 
                                ? simplifyFraction(correct.denom * (correct.num < 0 ? -1 : 1), Math.abs(correct.num))
                                : toFraction(1 / x || 1);
                            mulDivError = toFraction((params.g - params.f) * params.e);
                            addError1 = toFraction(params.g * params.f + params.e);
                            addError2 = toFraction(params.g * params.f - params.e);
                            divError1 = toFraction(params.e / (params.g - params.f));
                            divError2 = toFraction(params.e / (params.g + params.f));
                            addError3 = toFraction(params.g - params.f + params.e);
                            break;
                        case 'h=i+kx':
                            noSignChange = toFraction((params.h + params.i) / params.k);
                            swapFrac = correct.denom !== 1 && correct.num !== 0 
                                ? simplifyFraction(correct.denom * (correct.num < 0 ? -1 : 1), Math.abs(correct.num))
                                : toFraction(1 / x || 1);
                            mulDivError = toFraction((params.h - params.i) * params.k);
                            addError1 = toFraction(params.h * params.i + params.k);
                            addError2 = toFraction(params.h * params.i - params.k);
                            divError1 = toFraction(params.k / (params.h - params.i));
                            divError2 = toFraction(params.k / (params.h + params.i));
                            addError3 = toFraction(params.h - params.i + params.k);
                            break;
                        case 'm=l+nx':
                            noSignChange = toFraction((params.m + params.l) / params.n);
                            swapFrac = correct.denom !== 1 && correct.num !== 0 
                                ? simplifyFraction(correct.denom * (correct.num < 0 ? -1 : 1), Math.abs(correct.num))
                                : toFraction(1 / x || 1);
                            mulDivError = toFraction((params.m - params.l) * params.n);
                            addError1 = toFraction(params.m * params.l + params.n);
                            addError2 = toFraction(params.m * params.l - params.n);
                            divError1 = toFraction(params.n / (params.m - params.l));
                            divError2 = toFraction(params.n / (params.m + params.l));
                            addError3 = toFraction(params.m - params.l + params.n);
                            break;
                        case 'c=dx':
                            addPair(correct); // x, -x
                            addPair(simplifyFraction(params.c * params.d, 1)); // c*d, -c*d
                            addPair(simplifyFraction(params.d, params.c)); // d/c, -d/c
                            addPair(simplifyFraction(1, 1)); // 1, -1
                            break;
                        default:
                            throw new Error('Invalid equation type');
                    }
                    if (type !== 'c=dx') {
                        addPair(correct);
                        addPair(noSignChange);
                        addPair(swapFrac);
                        addPair(mulDivError);
                        addPair(addError1);
                        addPair(addError2);
                        addPair(divError1);
                        addPair(divError2);
                        addPair(addError3);
                    }
                }
            }

            // Ensure exactly 10 options
            if (options.length < 10) {
                let randomOpt;
                do {
                    const isFraction = Math.random() < 0.5;
                    if (isFraction) {
                        let num = Math.floor(Math.random() * 18) + 1;
                        let denom = Math.floor(Math.random() * 9) + 2;
                        randomOpt = simplifyFraction(num, denom);
                    } else {
                        const num = Math.floor(Math.random() * 21) + 1;
                        randomOpt = simplifyFraction(num, 1);
                    }
                } while (options.some(o => areFractionsEqual(o, randomOpt)));
                options.push(randomOpt);
            } else if (options.length > 10) {
                options.splice(10); // Trim to 10
            }

            // Sort options by numerical value
            options.sort((a, b) => (a.num / a.denom) - (b.num / b.denom));

            // Validate option counts and simplification
            const negativeOptions = options.filter(opt => opt.num / opt.denom < 0);
            const positiveOptions = options.filter(opt => opt.num / opt.denom > 0);
            const zeroOptions = options.filter(opt => opt.num === 0);
            options.forEach(opt => {
                if (opt.denom !== 1 && opt.num !== 0) {
                    const divisor = gcd(Math.abs(opt.num), opt.denom);
                    if (divisor !== 1) {
                        console.warn(`Unsimplified fraction detected: ${opt.num}/${opt.denom}, GCD: ${divisor}`);
                    }
                }
            });
            console.log('Options generated:', {
                total: options.length,
                negative: negativeOptions.length,
                positive: positiveOptions.length,
                zero: zeroOptions.length,
                options: options.map(opt => `${opt.num}/${opt.denom}`)
            });

            if (negativeOptions.length !== 4 || positiveOptions.length !== 4 || zeroOptions.length !== 1) {
                console.warn('Option count mismatch, regenerating:', {
                    negative: negativeOptions.length,
                    positive: positiveOptions.length,
                    zero: zeroOptions.length
                });
                options.length = 0;
                options.push(zero);
                addPair(correct);
                addPair(simplifyFraction(Math.floor(Math.random() * 10) + 1, 1));
                addPair(simplifyFraction(Math.floor(Math.random() * 10) + 1, Math.floor(Math.random() * 5) + 2));
                addPair(simplifyFraction(Math.floor(Math.random() * 20) + 1, 1));
                let randomOpt;
                do {
                    const num = Math.floor(Math.random() * 21) + 1;
                    randomOpt = simplifyFraction(num, 1);
                } while (options.some(o => areFractionsEqual(o, randomOpt)));
                options.push(randomOpt);
                options.sort((a, b) => (a.num / a.denom) - (b.num / b.denom));
            }

            return options.map(opt => ({
                value: opt.num === 0 ? '0' : `${opt.num}/${opt.denom}`,
                display: formatNumber(opt)
            }));
        } catch (e) {
            console.error('Error in generateAnswerOptions:', e);
            // Fallback options (all simplified)
            const fallback = [
                simplifyFraction(-4, 1), simplifyFraction(4, 1),
                simplifyFraction(-5, 3), simplifyFraction(5, 3),
                simplifyFraction(-16, 1), simplifyFraction(16, 1),
                simplifyFraction(-3, 5), simplifyFraction(3, 5),
                simplifyFraction(0, 1),
                simplifyFraction(7, 1)
            ];
            return fallback.map(opt => ({
                value: opt.num === 0 ? '0' : `${opt.num}/${opt.denom}`,
                display: formatNumber(opt)
            }));
        }
    }

    function generateLinearEquation() {
        try {
            const types = ['ax=b', 'c=dx', 'ex+f=g', 'h=i+kx', 'm=l+nx'];
            const type = types[Math.floor(Math.random() * types.length)];
            let a, b, c, d, e, f, g, h, i, k, l, m, n, x;

            // 1/3 probability for fractional solution
            const isFractional = Math.random() < 1/3;

            if (isFractional) {
                switch (type) {
                    case 'ax=b':
                        a = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) a = -a;
                        b = Math.floor(Math.random() * 21) - 10;
                        if (b === 0) b = 1; // Avoid division by zero
                        x = b / a;
                        return { type, a, b, x, options: generateAnswerOptions(x, type, { a, b }) };
                    case 'c=dx':
                        d = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) d = -d;
                        c = Math.floor(Math.random() * 21) - 10;
                        if (c === 0) c = 1; // Avoid trivial equation
                        x = c / d;
                        return { type, c, d, x, options: generateAnswerOptions(x, type, { c, d }) };
                    case 'ex+f=g':
                        e = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) e = -e;
                        f = Math.floor(Math.random() * 21) - 10;
                        g = Math.floor(Math.random() * 21) - 10;
                        x = (g - f) / e;
                        return { type, e, f, g, x, options: generateAnswerOptions(x, type, { e, f, g }) };
                    case 'h=i+kx':
                        k = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) k = -k;
                        i = Math.floor(Math.random() * 21) - 10;
                        h = Math.floor(Math.random() * 21) - 10;
                        x = (h - i) / k;
                        return { type, h, i, k, x, options: generateAnswerOptions(x, type, { h, i, k }) };
                    case 'm=l+nx':
                        n = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) n = -n;
                        l = Math.floor(Math.random() * 21) - 10;
                        m = Math.floor(Math.random() * 21) - 10;
                        x = (m - l) / n;
                        return { type, m, l, n, x, options: generateAnswerOptions(x, type, { m, l, n }) };
                }
            } else {
                x = Math.floor(Math.random() * 21) - 10;
                switch (type) {
                    case 'ax=b':
                        a = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) a = -a;
                        b = a * x;
                        return { type, a, b, x, options: generateAnswerOptions(x, type, { a, b }) };
                    case 'c=dx':
                        d = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) d = -d;
                        c = d * x;
                        return { type, c, d, x, options: generateAnswerOptions(x, type, { c, d }) };
                    case 'ex+f=g':
                        e = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) e = -e;
                        f = Math.floor(Math.random() * 21) - 10;
                        g = e * x + f;
                        return { type, e, f, g, x, options: generateAnswerOptions(x, type, { e, f, g }) };
                    case 'h=i+kx':
                        k = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) k = -k;
                        i = Math.floor(Math.random() * 21) - 10;
                        h = i + k * x;
                        return { type, h, i, k, x, options: generateAnswerOptions(x, type, { h, i, k }) };
                    case 'm=l+nx':
                        n = Math.floor(Math.random() * 10) + 1;
                        if (Math.random() < 0.5) n = -n;
                        l = Math.floor(Math.random() * 21) - 10;
                        m = l + n * x;
                        return { type, m, l, n, x, options: generateAnswerOptions(x, type, { m, l, n }) };
                }
            }
        } catch (e) {
            console.error('Error in generateLinearEquation:', e);
            return {
                type: 'ax=b',
                a: 1,
                b: 1,
                x: 1,
                options: [
                    { value: '-4/1', display: '-4' },
                    { value: '4/1', display: '4' },
                    { value: '-5/3', display: '-\\frac{5}{3}' },
                    { value: '5/3', display: '\\frac{5}{3}' },
                    { value: '-3/5', display: '-\\frac{3}{5}' },
                    { value: '3/5', display: '\\frac{3}{5}' },
                    { value: '-16/1', display: '-16' },
                    { value: '16/1', display: '16' },
                    { value: '0', display: '0' },
                    { value: '7/1', display: '7' }
                ]
            };
        }
    }

    function formatEquation(problem) {
        try {
            const { type } = problem;
            switch (type) {
                case 'ax=b':
                    return `${formatNumber(problem.a)}x = ${formatNumber(problem.b)}`;
                case 'c=dx':
                    return `${formatNumber(problem.c)} = ${formatNumber(problem.d)}x`;
                case 'ex+f=g':
                    let eq = `${formatNumber(problem.e)}x`;
                    if (problem.f !== 0) eq += ` ${problem.f > 0 ? '+' : '-'} ${Math.abs(problem.f)}`;
                    eq += ` = ${formatNumber(problem.g)}`;
                    return eq;
                case 'h=i+kx':
                    let eq2 = `${formatNumber(problem.h)} = ${formatNumber(problem.i)}`;
                    if (problem.k !== 0) eq2 += ` ${problem.k > 0 ? '+' : '-'} ${Math.abs(problem.k)}x`;
                    return eq2;
                case 'm=l+nx':
                    let eq3 = `${formatNumber(problem.m)} = ${formatNumber(problem.l)}`;
                    if (problem.n !== 0) eq3 += ` ${problem.n > 0 ? '+' : '-'} ${Math.abs(problem.n)}x`;
                    return eq3;
                default:
                    throw new Error('Invalid equation type');
            }
        } catch (e) {
            console.error('Error in formatEquation:', e);
            return 'x = 1';
        }
    }

    function displayStars() {
        try {
            const starsDiv = document.getElementById('stars');
            starsDiv.innerHTML = '★'.repeat(starCount) + '☆'.repeat(10 - starCount);
        } catch (e) {
            console.error('Error in displayStars:', e);
        }
    }

    function showFeedback(message, isCorrect, duration = null) {
        try {
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.innerHTML = message;
            feedbackDiv.className = isCorrect ? 'correct' : 'incorrect';
            if (duration) {
                setTimeout(() => {
                    feedbackDiv.innerHTML = '';
                    feedbackDiv.className = '';
                }, duration);
            }
        } catch (e) {
            console.error('Error in showFeedback:', e);
        }
    }

    function shakeScreen() {
        try {
            const contentDiv = document.getElementById('content');
            contentDiv.classList.add('shake');
            setTimeout(() => {
                contentDiv.classList.remove('shake');
            }, 500);
        } catch (e) {
            console.error('Error in shakeScreen:', e);
        }
    }

    function triggerConfetti() {
        try {
            const canvas = document.getElementById('confetti-canvas');
            const confettiInstance = confetti.create(canvas, { resize: true });
            confettiInstance({
                particleCount: 80,
                spread: 60,
                origin: { y: 0.6 },
                duration: 2500
            });
        } catch (e) {
            console.error('Error in triggerConfetti:', e);
        }
    }

    function showPasswordInput() {
        try {
            const congratulationsDiv = document.getElementById('congratulations');
            const passwordContainer = document.getElementById('passwordContainer');
            congratulationsDiv.style.display = 'none';
            passwordContainer.style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordResult').innerHTML = '';
            MathJax.typeset();
        } catch (e) {
            console.error('Error in showPasswordInput:', e);
        }
    }

    function submitPasswordInput() {
        try {
            const passwordInput = document.getElementById('passwordInput').value;
            const passwordResult = document.getElementById('passwordResult');
            const number = parseInt(passwordInput);

            if (isNaN(number) || number < 1 || number > 50) {
                passwordResult.innerHTML = '請輸入 1 到 50 之間的數字';
                passwordResult.className = 'error';
            } else {
                const password = passJson ? passJson[number.toString()] : '密碼不可用';
                passwordResult.innerHTML = `密碼：${password}`;
                passwordResult.className = 'success';
                document.getElementById('passwordInput').disabled = true;
                document.getElementById('confirmPasswordBtn').disabled = true;
            }
            MathJax.typeset();
        } catch (e) {
            console.error('Error in submitPasswordInput:', e);
            showFeedback('密碼輸入失敗，請重試', false);
        }
    }

    function nextProblem() {
        try {
            if (typeof generateLinearEquation !== 'function') {
                throw new Error('generateLinearEquation is not defined');
            }

            problemCount++;
            hintLevel = 0;
            hints = [];
            document.title = `一元一次方程練習 ${problemCount}`;
            currentProblem = generateLinearEquation();

            // Ensure only one .controls div exists
            const existingControls = document.getElementsByClassName('controls');
            while (existingControls.length > 1) {
                existingControls[1].remove();
            }

            // Group options into negative, zero, and positive
            const negativeOptions = currentProblem.options.filter(opt => {
                const frac = parseInput(opt.value);
                return frac && frac.num / frac.denom < 0;
            });
            const zeroOption = currentProblem.options.filter(opt => opt.value === '0');
            const positiveOptions = currentProblem.options.filter(opt => {
                const frac = parseInput(opt.value);
                return frac && frac.num / frac.denom > 0;
            });

            const controlsDiv = document.getElementById('controls');
            controlsDiv.innerHTML = `
                <div class="input-group" id="options">
                    ${negativeOptions.length > 0 ? `
                        <div class="option-row">
                            ${negativeOptions.map(opt => `<button class="answerBtn" onclick="checkAnswer('${opt.value}')">\\(${opt.display}\\)</button>`).join('')}
                        </div>
                    ` : ''}
                    ${zeroOption.length > 0 ? `
                        <div class="option-row">
                            ${zeroOption.map(opt => `<button class="answerBtn" onclick="checkAnswer('${opt.value}')">\\(${opt.display}\\)</button>`).join('')}
                        </div>
                    ` : ''}
                    ${positiveOptions.length > 0 ? `
                        <div class="option-row">
                            ${positiveOptions.map(opt => `<button class="answerBtn" onclick="checkAnswer('${opt.value}')">\\(${opt.display}\\)</button>`).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="action-buttons">
                    <button id="hintBtn" onclick="showHint()">提示</button>
                    <button id="nextProblemBtn" onclick="resetStarsAndNextProblem()">下一題</button>
                </div>
            `;

            const problemDiv = document.getElementById('problem');
            problemDiv.innerHTML = `解方程：\\[${formatEquation(currentProblem)}\\]`;

            const answerDiv = document.getElementById('answer');
            answerDiv.style.display = 'none';
            answerDiv.innerHTML = `答案：\\(x = ${formatNumber(toFraction(currentProblem.x))}\\)`;

            const hintDiv = document.getElementById('hint');
            hintDiv.style.display = 'none';
            hintDiv.innerHTML = '';

            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.innerHTML = '';
            feedbackDiv.className = '';

            const congratulationsDiv = document.getElementById('congratulations');
            congratulationsDiv.style.display = 'none';
            congratulationsDiv.innerHTML = '';

            const passwordContainer = document.getElementById('passwordContainer');
            passwordContainer.style.display = 'none';
            const passwordInput = document.getElementById('passwordInput');
            passwordInput.value = '';
            passwordInput.disabled = false;
            document.getElementById('confirmPasswordBtn').disabled = false;
            document.getElementById('passwordResult').innerHTML = '';

            displayStars();
            MathJax.typeset();
        } catch (e) {
            console.error('Error in nextProblem:', e);
            showFeedback('題目加載失敗，請重新載入頁面', false);
        }
    }

    function resetStarsAndNextProblem() {
        try {
            starCount = 0;
            nextProblem();
        } catch (e) {
            console.error('Error in resetStarsAndNextProblem:', e);
            showFeedback('無法加載下一題，請重新載入頁面', false);
        }
    }

    function checkAnswer(value) {
        try {
            const userX = parseInput(value);
            if (!userX) {
                showFeedback('無效的答案', false);
                return;
            }

            const correctX = toFraction(currentProblem.x);
            const isCorrect = areFractionsEqual(userX, correctX);

            const answerButtons = document.querySelectorAll('.answerBtn');
            const hintBtn = document.getElementById('hintBtn');
            const nextProblemBtn = document.getElementById('nextProblemBtn');

            if (isCorrect) {
                starCount++;
                showFeedback('恭喜答對, 獲得一粒星星', true, 1500);
                if (starCount >= 10) {
                    const congratulationsDiv = document.getElementById('congratulations');
                    congratulationsDiv.style.display = 'block';
                    congratulationsDiv.innerHTML = '恭喜完成練習！';
                    answerButtons.forEach(btn => btn.disabled = true);
                    hintBtn.disabled = true;
                    nextProblemBtn.disabled = true;
                    triggerConfetti();
                    if (hasPassJson) {
                        setTimeout(showPasswordInput, 1200);
                    }
                } else {
                    setTimeout(nextProblem, 1500);
                }
            } else {
                starCount = 0;
                shakeScreen();
                showFeedback('回答錯誤', false);
                answerButtons.forEach(btn => btn.disabled = true);
                hintBtn.disabled = true;
                nextProblemBtn.disabled = false;
                const passwordContainer = document.getElementById('passwordContainer');
                passwordContainer.style.display = 'none';
                while (hintLevel < 3) {
                    showHint();
                }
                const answerDiv = document.getElementById('answer');
                answerDiv.style.display = 'block';
            }

            displayStars();
            MathJax.typeset();
        } catch (e) {
            console.error('Error in checkAnswer:', e);
            showFeedback('答案檢查失敗，請重試', false);
        }
    }

    function showHint() {
        try {
            const hintDiv = document.getElementById('hint');
            const hintBtn = document.getElementById('hintBtn');
            hintDiv.style.display = 'block';
            document.querySelectorAll('.answerBtn').forEach(btn => btn.disabled = true);
            const passwordContainer = document.getElementById('passwordContainer');
            passwordContainer.style.display = 'none';

            const { type, x } = currentProblem;
            hintLevel++;

            const xFrac = toFraction(x);
            if (type === 'ax=b') {
                const { a, b } = currentProblem;
                const aFrac = toFraction(a);
                const bFrac = toFraction(b);
                if (hintLevel === 1) {
                    hints = [`提示 1：將方程兩邊同時除以 ${formatNumber(aFrac)}：\\[x = \\frac{${formatNumber(bFrac)}}{${formatNumber(aFrac)}}\\]`];
                } else if (hintLevel === 2) {
                    hints.push(`提示 2：計算右邊的分數：\\[x = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                } else {
                    hints.push(`提示 3：答案為 \\[x = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                    return;
                }
            } else if (type === 'c=dx') {
                const { c, d } = currentProblem;
                const cFrac = toFraction(c);
                const dFrac = toFraction(d);
                if (hintLevel === 1) {
                    hints = [`提示 1：將方程兩邊同時除以 ${formatNumber(dFrac)}：\\[x = \\frac{${formatNumber(cFrac)}}{${formatNumber(dFrac)}}\\]`];
                } else if (hintLevel === 2) {
                    hints.push(`提示 2：計算右邊的分數：\\[x = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                } else {
                    hints.push(`提示 3：答案為 \\[x = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                    return;
                }
            } else if (type === 'ex+f=g') {
                const { e, f, g } = currentProblem;
                const eFrac = toFraction(e);
                const fFrac = toFraction(f);
                const gFrac = toFraction(g);
                const rightSide = toFraction(g - f);
                if (hintLevel === 1) {
                    hints = [`提示 1：將常數項移到右邊：\\[${formatNumber(eFrac)}x = ${formatNumber(gFrac)} ${f > 0 ? '-' : '+'} ${formatNumber({num: Math.abs(fFrac.num), denom: fFrac.denom})}\\]`];
                } else if (hintLevel === 2) {
                    hints.push(`提示 2：計算右邊並除以 ${formatNumber(eFrac)}：\\[x = \\frac{${formatNumber(rightSide)}}{${formatNumber(eFrac)}} = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                } else {
                    hints.push(`提示 3：答案為 \\[x = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                    return;
                }
            } else if (type === 'h=i+kx') {
                const { h, i, k } = currentProblem;
                const hFrac = toFraction(h);
                const iFrac = toFraction(i);
                const kFrac = toFraction(k);
                const rightSide = toFraction(h - i);
                if (hintLevel === 1) {
                    hints = [`提示 1：將常數項移到右邊：\\[${formatNumber(kFrac)}x = ${formatNumber(hFrac)} ${i > 0 ? '-' : '+'} ${formatNumber({num: Math.abs(iFrac.num), denom: iFrac.denom})}\\]`];
                } else if (hintLevel === 2) {
                    hints.push(`提示 2：計算右邊並除以 ${formatNumber(kFrac)}：\\[x = \\frac{${formatNumber(rightSide)}}{${formatNumber(kFrac)}} = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                } else {
                    hints.push(`提示 3：答案為 \\[x = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                    return;
                }
            } else if (type === 'm=l+nx') {
                const { m, l, n } = currentProblem;
                const mFrac = toFraction(m);
                const lFrac = toFraction(l);
                const nFrac = toFraction(n);
                const rightSide = toFraction(m - l);
                if (hintLevel === 1) {
                    hints = [`提示 1：將常數項移到右邊：\\[${formatNumber(nFrac)}x = ${formatNumber(mFrac)} ${l > 0 ? '-' : '+'} ${formatNumber({num: Math.abs(lFrac.num), denom: lFrac.denom})}\\]`];
                } else if (hintLevel === 2) {
                    hints.push(`提示 2：計算右邊並除以 ${formatNumber(nFrac)}：\\[x = \\frac{${formatNumber(rightSide)}}{${formatNumber(nFrac)}} = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                } else {
                    hints.push(`提示 3：答案為 \\[x = ${formatNumber(xFrac)}\\]`);
                    hintBtn.disabled = true;
                    showAnswer();
                    return;
                }
            }

            hintDiv.innerHTML = hints.join('<br>');
            MathJax.typeset();
        } catch (e) {
            console.error('Error in showHint:', e);
            showFeedback('無法顯示提示，請重試', false);
        }
    }

    function showAnswer() {
        try {
            const answerDiv = document.getElementById('answer');
            answerDiv.style.display = 'block';
            document.querySelectorAll('.answerBtn').forEach(btn => btn.disabled = true);
            const hintBtn = document.getElementById('hintBtn');
            hintBtn.disabled = true;
            const passwordContainer = document.getElementById('passwordContainer');
            passwordContainer.style.display = 'none';
            MathJax.typeset();
        } catch (e) {
            console.error('Error in showAnswer:', e);
            showFeedback('無法顯示答案，請重試', false);
        }
    }

    window.onload = function() {
        try {
            checkPassJson().then(() => {
                displayStars();
                nextProblem();
            }).catch(err => {
                console.error('Initialization error:', err);
                showFeedback('應用程式初始化失敗，請重新載入頁面', false);
            });
        } catch (e) {
            console.error('Error in window.onload:', e);
            showFeedback('應用程式初始化失敗，請重新載入頁面', false);
        }
    };
</script>
</body>
</html>
