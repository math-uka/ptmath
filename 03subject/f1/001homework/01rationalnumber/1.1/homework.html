<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數學作業 12</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true
            },
            chtml: {
                scale: 1.0,
                mtextInheritFont: true
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    MathJax.startup.promise.then(() => {
                        console.log('MathJax is ready');
                    });
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@0.11.0/dist/js-confetti.browser.js"></script>
    <style>
        :root {
            --primary-color: #1e88e5;
            --secondary-color: #43a047;
            --accent-color: #e53935;
            --light-gray: #f5f5f5;
            --dark-gray: #333;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: var(--dark-gray);
            background-color: #fafafa;
        }

        body.challenge-mode {
            --primary-color: #e53935;
            --secondary-color: #d32f2f;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        h1, h2, h3 {
            color: var(--primary-color);
        }

        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-container {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-start;
        }

        .input-group {
            display: flex;
            flex-direction: row;
            gap: 20px;
            align-items: flex-start;
        }

        .input-subgroup {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
            flex: 1;
        }

        input {
            padding: 12px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #1565c0;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .input-button {
            padding: 8px 16px;
            background-color: var(--secondary-color);
            color: white;
            font-size: 14px;
            margin-right: 5px;
        }

        .input-button:hover {
            background-color: #2e7d32;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 6px;
            font-size: 1.1em;
        }

        .help-container {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
            padding: 15px;
        }

        .stars-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .star {
            font-size: 30px;
            color: #ccc;
            margin: 0 5px;
            transition: all 0.3s;
        }

        .star.active {
            color: #f1c40f;
            transform: scale(1.2);
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        .error-message {
            color: #e74c3c;
            background-color: #fdedec;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            text-align: center;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            font-size: 0.9em;
            color: #777;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="practiceTitle">載入中...</h1>
        <p id="headerText">通過互動練習和詳細教學，輕鬆掌握方程解題技巧！</p>
    </header>

    <div class="card" id="rules" style="display:none;">
        <h2>答題規則介紹</h2>
        <div class="help-container" id="rulesContent">載入中...</div>
    </div>

    <div class="card" id="quiz">
        <h2>練習題目 <span id="questionNumber">1</span>/<span id="totalQuestions">3</span></h2>
        <div class="stars-container" id="starsContainer"></div>
        <p id="questionText">載入中...</p>
        <div class="input-container" id="answerContainer">
            <span id="answerPrefix"></span>
            <div class="input-group">
                <div class="input-subgroup">
                    <input type="text" id="answerInput1" placeholder="輸入答案">
                    <div class="button-group">
                        <button class="input-button" onclick="insertText('/', 'answerInput1')">分數</button>
                        <button class="input-button" onclick="insertText('√', 'answerInput1')">根號</button>
                        <button class="input-button" onclick="insertText('無解', 'answerInput1')">無解</button>
                        <button class="input-button" onclick="insertText('+', 'answerInput1')">+</button>
                        <button class="input-button" onclick="insertText('-', 'answerInput1')">-</button>
                    </div>
                </div>
            </div>
        </div>
        <button id="submit-btn" onclick="checkAnswer()">提交答案</button>
        <button id="next-btn" style="display:none;" onclick="nextQuestion()">下一題</button>
        <div class="feedback" id="feedback"></div>
    </div>

    <div class="card" id="completion-message" style="display:none;">
        <h2>恭喜成功完成所有挑戰！</h2>
        <div id="student-id-section" style="display:none;">
            <p>請輸入您的學號 (1-50)：</p>
            <input type="number" id="student-id" min="1" max="50">
            <button id="get-password-btn" onclick="getPassword()">獲取密碼</button>
            <div id="password-display" style="display:none;"></div>
        </div>
    </div>

    <div class="card">
        <h2>教學指南</h2>
        <div class="help-container" id="helpContent">載入中...</div>
    </div>

    <div class="card">
        <h2>操作指南</h2>
        <div class="help-container" id="operationGuide">
            <ul>
                <li><strong>輸入分數</strong>：點擊「分數」按鈕，輸入框中會插入 <code>/</code>，然後輸入分子和分母，例如 <code>1/2</code> 表示 \(\frac{1}{2}\)。 </li>
                <li><strong>輸入「無解」</strong>：點擊「無解」按鈕，輸入框中會直接插入「無解」，表示方程無解。</li>
                <li><strong>輸入帶根號的數</strong>：先輸入數字部分（常數或係數），然後點擊「根號」按鈕，再輸入根號下的數字，例如輸入 <code>2+√3</code> 表示 \(2 + \sqrt{3}\)。 </li>
            </ul>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 ukawai</p>
    </footer>

    <script>
        const jsConfetti = new JSConfetti();
        let questions = [];
        let hwhQuestions = [];
        let currentQuestion = null;
        let usedQuestions = JSON.parse(localStorage.getItem('usedQuestions')) || [];
        let usedHwhQuestions = JSON.parse(localStorage.getItem('usedHwhQuestions')) || [];
        let questionCount = 3;
        let stars = 0;
        let correctCount = 0;
        let currentQuestionNumber = 1;
        let passData = null;
        let isChallengeMode = false;
        let hasEnteredChallengeMode = false;
        let hasHwh = false;

        // 禁用右鍵選單
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        // 禁用 F12、Ctrl+S 和 Ctrl+U
        document.addEventListener('keydown', (e) => {
            if (
                e.key === 'F12' ||
                (e.ctrlKey && (e.key === 's' || e.key === 'u'))
            ) {
                e.preventDefault();
            }
        });

        function initializeStars() {
            const starsContainer = document.getElementById('starsContainer');
            starsContainer.innerHTML = '';
            for (let i = 0; i < questionCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.textContent = '★';
                starsContainer.appendChild(star);
            }
            updateStars();
        }

        fetch('total.json')
            .then(response => response.ok ? response.json() : Promise.reject('無 total.json'))
            .then(data => {
                questionCount = data.questionCount || 3;
                document.getElementById('totalQuestions').textContent = questionCount;
                initializeStars();
            })
            .catch(() => {
                document.getElementById('totalQuestions').textContent = questionCount;
                initializeStars();
            });

        fetch('pass.json')
            .then(response => response.ok ? response.json() : null)
            .then(data => passData = data)
            .catch(() => console.log('無 pass.json'));

        fetch('hwh.json')
            .then(response => response.ok ? response.json() : Promise.reject('無 hwh.json'))
            .then(data => {
                hasHwh = true;
                hwhQuestions = data.questions;
            })
            .catch(() => {
                hasHwh = false;
            });

        fetch('hw.json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('practiceTitle').textContent = data.title;
                questions = data.questions;
                loadNewQuestion();
            });

        fetch('help.json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('helpContent').innerHTML = data.content;
                MathJax.typesetPromise().catch(err => console.error('MathJax typesetting error:', err));
            });

        fetch('rule.json')
            .then(response => response.ok ? response.json() : Promise.reject('無 rule.json'))
            .then(data => {
                document.getElementById('rules').style.display = 'block';
                document.getElementById('rulesContent').innerHTML = data.content;
                MathJax.typesetPromise().catch(err => console.error('MathJax typesetting error:', err));
            })
            .catch(() => {
                document.getElementById('rules').style.display = 'none';
            });

        function loadNewQuestion() {
            let currentQuestions = isChallengeMode ? hwhQuestions : questions;
            let currentUsedQuestions = isChallengeMode ? usedHwhQuestions : usedQuestions;
            let currentStorageKey = isChallengeMode ? 'usedHwhQuestions' : 'usedQuestions';

            // 檢查星星數是否達到 questionCount - 3，進入挑戰模式
            if (hasHwh && !hasEnteredChallengeMode && stars === questionCount - 3) {
                isChallengeMode = true;
                hasEnteredChallengeMode = true;
                document.body.classList.add('challenge-mode');
                document.getElementById('headerText').textContent = '你已進入挑戰模式';
                currentQuestions = hwhQuestions;
                currentUsedQuestions = usedHwhQuestions;
                currentStorageKey = 'usedHwhQuestions';
            }

            let availableQuestions = currentQuestions.filter((q, index) => !currentUsedQuestions.includes(index));
            if (availableQuestions.length === 0) {
                currentUsedQuestions.length = 0;
                localStorage.setItem(currentStorageKey, JSON.stringify(currentUsedQuestions));
                availableQuestions = currentQuestions;
            }
            const index = Math.floor(Math.random() * availableQuestions.length);
            currentQuestion = availableQuestions[index];
            currentUsedQuestions.push(currentQuestions.indexOf(currentQuestion));
            localStorage.setItem(currentStorageKey, JSON.stringify(currentUsedQuestions));
            document.getElementById('questionText').innerHTML = currentQuestion.question;
            const answerContainer = document.getElementById('answerContainer');
            const prefixes = Array.isArray(currentQuestion.prefix) ? currentQuestion.prefix : [currentQuestion.prefix || ''];
            answerContainer.innerHTML = currentQuestion.answers.length > 1
                ? `
                    <div class="input-group">
                        <div class="input-subgroup">
                            <span id="answerPrefix1">${prefixes[0]}</span>
                            <input type="text" id="answerInput1" placeholder="輸入第一個答案">
                            <div class="button-group">
                                <button class="input-button" onclick="insertText('/', 'answerInput1')">分數</button>
                                <button class="input-button" onclick="insertText('√', 'answerInput1')">根號</button>
                                <button class="input-button" onclick="insertText('無解', 'answerInput1')">無解</button>
                                <button class="input-button" onclick="insertText('+', 'answerInput1')">+</button>
                                <button class="input-button" onclick="insertText('-', 'answerInput1')">-</button>
                            </div>
                        </div>
                        <div class="input-subgroup">
                            <span id="answerPrefix2">${prefixes[1] || prefixes[0]}</span>
                            <input type="text" id="answerInput2" placeholder="輸入第二個答案">
                            <div class="button-group">
                                <button class="input-button" onclick="insertText('/', 'answerInput2')">分數</button>
                                <button class="input-button" onclick="insertText('√', 'answerInput2')">根號</button>
                                <button class="input-button" onclick="insertText('無解', 'answerInput2')">無解</button>
                                <button class="input-button" onclick="insertText('+', 'answerInput2')">+</button>
                                <button class="input-button" onclick="insertText('-', 'answerInput2')">-</button>
                            </div>
                        </div>
                    </div>
                `
                : `
                    <div class="input-group">
                        <div class="input-subgroup">
                            <span id="answerPrefix1">${prefixes[0]}</span>
                            <input type="text" id="answerInput1" placeholder="輸入答案">
                            <div class="button-group">
                                <button class="input-button" onclick="insertText('/', 'answerInput1')">分數</button>
                                <button class="input-button" onclick="insertText('√', 'answerInput1')">根號</button>
                                <button class="input-button" onclick="insertText('無解', 'answerInput1')">無解</button>
                                <button class="input-button" onclick="insertText('+', 'answerInput1')">+</button>
                                <button class="input-button" onclick="insertText('-', 'answerInput1')">-</button>
                            </div>
                        </div>
                    </div>
                `;
            setTimeout(() => {
                MathJax.typesetPromise().catch(err => console.error('MathJax typesetting error:', err));
            }, 100);
            document.getElementById('submit-btn').style.display = 'inline-block';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('feedback').textContent = '';
        }

        function insertText(text, inputId) {
            const targetInput = document.getElementById(inputId);
            if (!targetInput) return;
            if (text === '無解') {
                targetInput.value = text;
            } else {
                targetInput.value += text;
            }
            targetInput.focus();
        }

        function parseAnswer(answer) {
            answer = answer.trim();
            if (answer === '無解') return answer;
            if (answer.includes('/')) {
                const [num, denom] = answer.split('/').map(Number);
                if (denom === 0) return NaN;
                return num / denom;
            }
            const sqrtMatch = answer.match(/^([+-]?\d*\.?\d*)?\s*([+-])\s*√(\d+)$/);
            if (sqrtMatch) {
                const constant = sqrtMatch[1] ? parseFloat(sqrtMatch[1]) : 0;
                const sign = sqrtMatch[2] === '+' ? 1 : -1;
                const sqrtValue = Math.sqrt(parseFloat(sqrtMatch[3]));
                return constant + sign * sqrtValue;
            }
            return Number(answer);
        }

        function checkAnswer() {
            const feedback = document.getElementById('feedback');
            const quizDiv = document.getElementById('quiz');
            const submitBtn = document.getElementById('submit-btn');
            let userAnswers = [document.getElementById('answerInput1').value.trim()];
            if (currentQuestion.answers.length > 1) {
                userAnswers.push(document.getElementById('answerInput2').value.trim());
            }
            let isCorrect;
            if (currentQuestion.answers.length === 1) {
                const userValue = parseAnswer(userAnswers[0]);
                const correctValue = parseAnswer(currentQuestion.answers[0]);
                isCorrect = userValue === correctValue || userAnswers[0] === currentQuestion.answers[0];
            } else {
                const userValues = userAnswers.map(parseAnswer).sort((a, b) => a - b);
                const correctValues = currentQuestion.answers.map(parseAnswer).sort((a, b) => a - b);
                isCorrect = userValues.length === correctValues.length &&
                           userValues.every((val, i) => val === correctValues[i] || 
                           (typeof val === 'number' && typeof correctValues[i] === 'number' && Math.abs(val - correctValues[i]) < 1e-10));
            }
            submitBtn.disabled = true;
            if (isCorrect) {
                stars++;
                updateStars();
                jsConfetti.addConfetti({
                    confettiColors: ['#f1c40f'],
                    confettiNumber: 30,
                    confettiRadius: 6,
                });
                feedback.textContent = '正確！';
                feedback.style.color = 'green';
                correctCount++;
                if (isChallengeMode || stars >= questionCount) {
                    jsConfetti.addConfetti({
                        confettiNumber: 500,
                        confettiRadius: 6,
                    });
                    document.getElementById('quiz').style.display = 'none';
                    document.getElementById('completion-message').style.display = 'block';
                    if (passData) {
                        setTimeout(() => {
                            document.getElementById('student-id-section').style.display = 'block';
                        }, 2000);
                    }
                    return;
                }
                setTimeout(() => {
                    nextQuestion();
                }, 1500);
            } else {
                if (isChallengeMode) {
                    isChallengeMode = false;
                    document.body.classList.remove('challenge-mode');
                    document.getElementById('headerText').textContent = '通過互動練習和詳細教學，輕鬆掌握方程解題技巧！';
                    feedback.innerHTML = `
                        <div class="error-message">
                            <span style="font-size:24px">✖</span><br>
                            答案錯誤！正確答案是 ${currentQuestion.answers.join(' 和 ')}。<br>
                            <small>已退出挑戰模式</small>
                        </div>
                    `;
                } else {
                    stars = 0;
                    updateStars();
                    feedback.innerHTML = `
                        <div class="error-message">
                            <span style="font-size:24px">✖</span><br>
                            答案錯誤！正確答案是 ${currentQuestion.answers.join(' 和 ')}。<br>
                            <small>星星已重置</small>
                        </div>
                    `;
                }
                quizDiv.classList.add('shake');
                setTimeout(() => {
                    quizDiv.classList.remove('shake');
                    document.getElementById('next-btn').style.display = 'inline-block';
                }, 500);
            }
        }

        function nextQuestion() {
            currentQuestionNumber++;
            document.getElementById('questionNumber').textContent = currentQuestionNumber;
            loadNewQuestion();
            document.getElementById('submit-btn').disabled = false;
        }

        function updateStars() {
            const starElements = document.querySelectorAll('.star');
            starElements.forEach((star, index) => {
                if (index < stars) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function getPassword() {
            const studentId = document.getElementById('student-id').value;
            const passwordDisplay = document.getElementById('password-display');
            if (!studentId || studentId < 1 || studentId > 50) {
                alert('請輸入有效的學號 (1-50)');
                return;
            }
            const password = passData[studentId];
            if (password) {
                passwordDisplay.textContent = `您的密碼是: ${password}`;
                passwordDisplay.style.display = 'block';
                document.getElementById('student-id').disabled = true;
                document.getElementById('get-password-btn').disabled = true;
            } else {
                alert('找不到對應的密碼');
            }
        }

        function resetQuiz() {
            usedQuestions = [];
            usedHwhQuestions = [];
            localStorage.setItem('usedQuestions', JSON.stringify(usedQuestions));
            localStorage.setItem('usedHwhQuestions', JSON.stringify(usedHwhQuestions));
            stars = 0;
            correctCount = 0;
            currentQuestionNumber = 1;
            isChallengeMode = false;
            hasEnteredChallengeMode = false;
            document.body.classList.remove('challenge-mode');
            document.getElementById('headerText').textContent = '通過互動練習和詳細教學，輕鬆掌握方程解題技巧！';
            document.getElementById('questionNumber').textContent = currentQuestionNumber;
            updateStars();
            loadNewQuestion();
            document.getElementById('quiz').style.display = 'block';
            document.getElementById('completion-message').style.display = 'none';
            document.getElementById('student-id-section').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                MathJax.typesetPromise().catch(err => console.error('MathJax initial typesetting error:', err));
            }, 100);
        });
    </script>
</body>
</html>